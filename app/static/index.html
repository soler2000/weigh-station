<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Weigh Station – Home</title>
  <!-- use the shared theme exactly like other pages -->
  <link rel="stylesheet" href="/static/styles.css?v=app-theme-1">
  <style>
    /* Only minimal, page-local helpers (theme stays in styles.css) */
    :root { --gap: 16px; }
    .page { max-width: 1200px; margin: 0 auto; padding: var(--gap); }
    .layout { display:grid; grid-template-columns: 2fr 1fr; gap: var(--gap); }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

    .reading-card{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:40vh}
    .reading{font-weight:800;font-size:clamp(56px,12vw,144px);line-height:1;letter-spacing:-.02em}
    .reading-sub{opacity:.85;margin-top:6px;transition:color .2s ease}
    .reading-sub.is-stable{color:#23ad4e}
    .reading-sub.is-unstable{color:#d63939}
    .reading-sub.is-measuring{color:#c28d1a}
    .status--pass{ background: rgba(35,173,78,.08) }  /* soft green tint */
    .status--fail{ background: rgba(214,57,57,.08) } /* soft red tint  */

    .formgrid{display:grid;grid-template-columns:150px 1fr;gap:10px 14px;align-items:center}
    .formgrid textarea{min-height:110px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .kpis{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:12px;margin-top:12px}
    .kpis .num{font-weight:700;font-size:clamp(20px,3.5vw,32px);text-align:center}
    .footer-msg{min-height:1.4em;margin-top:8px}
  </style>
</head>
<body class="app dark">
  <!-- same “chrome” as the other pages -->
  <header class="card topbar">
    <div class="brand">
      <img src="/static/gentex-logo.svg" alt="Gentex Corporation" class="brand-logo">
      <span class="brand-title">Weigh Station</span>
    </div>
    <nav class="nav">
      <a href="/" class="active">Home</a>
      <a href="/settings">Settings</a>
      <a href="/production">Production</a>
      <a href="/stats">Stats</a>
      <a href="/export">Export</a>
      <a href="/serial-log">Serial Log</a>
    </nav>
  </header>

  <main class="page">
    <div class="layout">
      <!-- Left: live reading -->
      <section class="card reading-card" id="readingCard">
        <div id="reading" class="reading">0.0 g</div>
        <div id="readingSub" class="reading-sub is-measuring">Waiting for scale…</div>
      </section>

      <!-- Right: controls -->
      <section class="card" style="padding:14px">
        <div class="formgrid">
          <label for="mouldingSerial">Moulding Serial</label>
          <input id="mouldingSerial" type="text" placeholder="Enter moulding serial">

          <label for="finalSerial">Final Serial</label>
          <input id="finalSerial" type="text" placeholder="Scan or enter final serial" autocomplete="off">

          <label for="variant">Variant</label>
          <select id="variant"></select>

          <label for="contract">Contract</label>
          <input id="contract" type="text" placeholder="Contract number">

          <label for="orderNumber">Order Number</label>
          <input id="orderNumber" type="text" placeholder="Order number">

          <label for="operator">Operator</label>
          <input id="operator" type="text" placeholder="Operator name">

          <label for="colour">Colour</label>
          <input id="colour" type="text" placeholder="Colour">

          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Notes for this weigh"></textarea>
        </div>

        <div class="actions">
          <button id="saveBtn">Save</button>
        </div>

        <div class="muted" style="margin-top:16px;margin-bottom:4px;font-size:0.95rem">Totals for today</div>
        <div class="kpis">
          <div class="card" style="padding:10px"><div style="opacity:.7">Pass</div><div id="passCount" class="num">0</div></div>
          <div class="card" style="padding:10px"><div style="opacity:.7">Fail</div><div id="failCount" class="num">0</div></div>
          <div class="card" style="padding:10px"><div style="opacity:.7">Total</div><div id="totalCount" class="num">0</div></div>
        </div>

        <div id="msg" class="footer-msg"></div>
      </section>
    </div>
  </main>

<script>
const $ = (id)=>document.getElementById(id);
let currentVariant = null;

const STICKY_FIELDS = ['mouldingSerial','contract','orderNumber','operator','colour'];
const STICKY_STORAGE_KEY = 'weighStationStickyFields';
const STICKY_TTL_MS = 30 * 60 * 1000;

function fmtG(x){ return (Math.round(x*10)/10).toFixed(1)+' g'; }
function setMsg(t, ok=true){ const m=$('msg'); if(!m) return; m.textContent=t||''; m.style.color = ok ? '' : '#b00'; }
function tint(ok){
  const c = $('readingCard'); if(!c) return; c.classList.remove('status--pass','status--fail');
  if(ok===true) c.classList.add('status--pass');
  if(ok===false) c.classList.add('status--fail');
}

async function loadVariants(){
  try{
    const v = await fetch('/api/variants',{cache:'no-store'}).then(r=>r.json());
    const sel = $('variant'); if(!sel) return;
    sel.innerHTML='';
    for(const it of v){
      const o=document.createElement('option');
      o.value=it.id; o.textContent=`${it.name || ('Variant '+it.id)} [${it.min_g}..${it.max_g} g]`;
      sel.appendChild(o);
    }
    if(v.length){ sel.value=v[0].id; currentVariant=v[0]; refreshStats(); }
    sel.addEventListener('change', ()=>{
      const id=parseInt(sel.value,10);
      currentVariant = v.find(x=>x.id===id) || null;
      refreshStats();
    });
  }catch{ setMsg('Failed to load variants', false); }
}

function updateScreen(d){
  $('reading').textContent = fmtG(d.g);
  const sub = $('readingSub');
  let status = 'Measuring';
  let statusClass = 'is-measuring';
  if(d.stable === true){
    status = 'Stable';
    statusClass = 'is-stable';
  }else if(d.stable === false){
    status = 'Unstable';
    statusClass = 'is-unstable';
  }
  sub.textContent = `${status} • ${new Date().toLocaleTimeString()}`;
  sub.classList.remove('is-stable','is-unstable','is-measuring');
  sub.classList.add(statusClass);
  if(currentVariant){
    const ok = (d.g >= currentVariant.min_g && d.g <= currentVariant.max_g);
    tint(ok);
  }
}

// WebSocket + polling fallback
(function connectWS(){
  const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
  const ws = new WebSocket(`${proto}://${location.host}/ws/weight`);
  ws.onmessage = ev => { try { updateScreen(JSON.parse(ev.data)); } catch{} };
  ws.onclose   = () => setTimeout(connectWS, 1200);
})();
setInterval(async ()=>{
  try{
    const d = await fetch('/api/debug/latest',{cache:'no-store'}).then(r=>r.json());
    if(d && typeof d.g==='number') updateScreen(d);
  }catch{}
}, 1500);

async function refreshStats(){
  try{
    const params = new URLSearchParams();
    if(currentVariant) params.set('variant_id', currentVariant.id);
    const s = await fetch('/api/stats'+(params.toString()?`?${params}`:''),{cache:'no-store'}).then(r=>r.json());
    $('passCount').textContent  = s.pass ?? 0;
    $('failCount').textContent  = s.fail ?? 0;
    $('totalCount').textContent = s.total ?? 0;
  }catch{}
}

function readSticky(){
  try{
    const raw = localStorage.getItem(STICKY_STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch{
    localStorage.removeItem(STICKY_STORAGE_KEY);
    return null;
  }
}

function clearStickyFields(clearInputs=true){
  localStorage.removeItem(STICKY_STORAGE_KEY);
  if(clearInputs){
    for(const id of STICKY_FIELDS){
      const el = $(id);
      if(el) el.value='';
    }
  }
}

function applyStickyFields(){
  const data = readSticky();
  if(!data) return;
  const ts = Number(data.ts);
  if(!ts || (Date.now()-ts) > STICKY_TTL_MS){
    clearStickyFields();
    return;
  }
  const values = data.values || {};
  for(const id of STICKY_FIELDS){
    if(Object.prototype.hasOwnProperty.call(values, id)){
      const el = $(id);
      if(el) el.value = values[id] ?? '';
    }
  }
}

function persistStickyFields(){
  const values = {};
  for(const id of STICKY_FIELDS){
    const el = $(id);
    values[id] = el ? el.value ?? '' : '';
  }
  try{
    localStorage.setItem(STICKY_STORAGE_KEY, JSON.stringify({ts: Date.now(), values}));
  }catch{}
}

function bindStickyHandlers(){
  for(const id of STICKY_FIELDS){
    const el = $(id);
    if(!el) continue;
    el.addEventListener('input', persistStickyFields);
    el.addEventListener('change', persistStickyFields);
  }
}

function checkStickyExpiry(){
  const data = readSticky();
  if(!data) return;
  const ts = Number(data.ts);
  if(!ts || (Date.now()-ts) > STICKY_TTL_MS){
    clearStickyFields();
  }
}

async function doSave(){
  try{
    if(!currentVariant){ setMsg('Choose variant first', false); return; }
    const finalSerialEl = $('finalSerial');
    const serial = (finalSerialEl?.value || '').trim();
    if(!serial){ setMsg('Final serial cannot be blank', false); finalSerialEl?.focus(); return; }

    const params = new URLSearchParams();
    params.set('variant_id', String(currentVariant.id));
    params.set('serial', serial);
    params.set('moulding_serial', ($('mouldingSerial')?.value || '').trim());
    params.set('contract', ($('contract')?.value || '').trim());
    params.set('order_number', ($('orderNumber')?.value || '').trim());
    params.set('operator', ($('operator')?.value || '').trim());
    params.set('colour', ($('colour')?.value || '').trim());
    params.set('notes', ($('notes')?.value || '').trim());

    const res = await fetch(`/api/weigh/commit?${params.toString()}`, {method:'POST'});
    if(res.status===409){ setMsg('Final serial already used', false); return; }
    if(!res.ok){ setMsg('Save failed', false); return; }
    setMsg('Saved');
    if(finalSerialEl) finalSerialEl.value='';
    persistStickyFields();
    refreshStats();
    finalSerialEl?.focus();
  }catch{ setMsg('Save error', false); }
}

window.addEventListener('load', ()=>{
  checkStickyExpiry();
  applyStickyFields();
  bindStickyHandlers();
  setInterval(checkStickyExpiry, 60000);
  loadVariants();
  setInterval(refreshStats, 3000);
  $('saveBtn')?.addEventListener('click', doSave);
  $('finalSerial')?.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); doSave(); }});
  $('finalSerial')?.focus();
});
</script>
</body>
</html>